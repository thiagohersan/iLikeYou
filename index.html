<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>iLoveYou (on Facebook)</title>
  <meta name="description" content="iLoveYou (on Facebook) is an app for letting someone know you love them (on Facebook).">
  <link href='http://fonts.googleapis.com/css?family=Lato:100,300,400,700' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300,600,700,800' rel='stylesheet' type='text/css'>
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
  <script type="text/javascript" src="./js/json2.js"></script>
  <link rel="stylesheet" type="text/css" href="css.css" />

  <meta property="og:title" content="iLoveYou (on Facebook)" />
  <meta property="og:type" content="article" />
  <meta property="og:url" content="http://www.thiagohersan.com/iLoveYou" />
  <meta property="og:image" content="http://www.thiagohersan.com/iLoveYou/imgs/receipt180.png" />
</head>
<body>
  <div id="fb-root"></div>
  <script>

  window.fbAsyncInit = function() {
    FB.init({
      appId      : '256150107871644',
      status     : true, // check login status
      cookie     : true, // enable cookies to allow the server to access the session
      xfbml      : true  // parse XFBML
    });

    FB.Event.subscribe('auth.authResponseChange', function(response) {
      if (response.status == 'connected') {
        myId = response.authResponse.userID;
      }
    });
  };

  // Load the SDK asynchronously
  (function(d){
    var js, id = 'facebook-jssdk', ref = d.getElementsByTagName('script')[0];
    if (d.getElementById(id)) {return;}
    js = d.createElement('script'); js.id = id; js.async = true;
    js.src = "//connect.facebook.net/en_US/all.js";
    ref.parentNode.insertBefore(js, ref);
  }(document));

  function centerVertical() {
    $("#main-body").css('height', $(window).height()+"px");
    $("#first-section").css('margin-top', ($(window).height() - $("#first-section").height())/2+"px");
  };

  var score, heartsPerRow, loverId, idQueue, currentDelay, myId;

  function addToScore(response, id){
    if(response == true){
      if(score%heartsPerRow == 0){
        $("#score").append("<br>");
      }
      score++;

      if((parseInt(id.slice(-1))%10) < 2){
        $("#score").append("<img src=\"./imgs/heart.png\" width=\"20\" >");
        drawCanvas(document.getElementById("heartImg"));
      }
      else{
       $("#score").append("<img src=\"./imgs/like.png\" width=\"20\" >");
       drawCanvas(document.getElementById("likeImg"));
      }
      centerVertical();
    }
    else if('error' in response){
      console.log(id+" :: "+response.error.message);
    }

    if(idQueue.length < 1){
      postCanvas();
    }
    else{
      function prepareApiCall(theId){
        return function(){ FB.api(theId+"/likes", 'post', function(response){ addToScore(response, theId); }); }
      }
      setTimeout(prepareApiCall(idQueue.shift()), currentDelay);
    }
  };

  function drawCanvas(img){
    var canvas = document.getElementById('myCanvas');
    var buffer = document.getElementById('canvasBuffer');
    var context = canvas.getContext('2d');
    var bufferContext = buffer.getContext('2d');

    var px = ((score-1)%heartsPerRow)*20;
    var py = Math.floor((score-1)/heartsPerRow)*20;

    context.canvas.width  = $("#score").width();
    context.canvas.height = py+20;
    if((buffer.width > 0) && (buffer.height > 0)){
      context.drawImage(buffer,0,0);
    }

    context.drawImage(img, px, py, 20,20);
    // save to buffer
    bufferContext.canvas.width  = context.canvas.width;
    bufferContext.canvas.height = context.canvas.height;
    bufferContext.drawImage(canvas,0,0);
  }

  function postCanvas(){
    var canvas = document.getElementById('myCanvas');
    if((canvas.width < 200) || (canvas.height < 200)){
      var context = canvas.getContext('2d');
      context.canvas.width  = Math.max(canvas.width, 200);
      context.canvas.height = Math.max(canvas.height, 200);
      context.drawImage(document.getElementById('canvasBuffer'),0,0);
    }

    $.ajax({
      type: "POST",
      url: "cgi-bin/canvas-save.php",
      data: { img : canvas.toDataURL() },
      success: function(response){
        FB.api('/me/photos',
          'post',
          { name: '<3',
          tags: [{'x':5, 'y':5, 'tag_uid':loverId}],
          url: 'http://www.thiagohersan.com/iLoveYou/'+response.replace("../","")},
          function(response){
            FB.api(response['id']+"/likes", 'post', function(response){});
        });
      }
    });
  }

  $(window).load(function(){
    centerVertical();
    score = 0;
    idQueue = [];
    loverId = '';
    currentDelay = 3000;
    heartsPerRow = Math.floor($("#score").parent().width()/20);
  });
  $(window).resize(centerVertical);

  function logMeIn(){
    FB.login(onLogIn, {scope: "read_stream,user_likes,publish_actions,publish_stream,user_likes,friends_checkins,friends_events,friends_interests,friends_likes,friends_notes,friends_photos,friends_status,friends_videos"});
  }

  function onLogIn(response) {
    if(('status' in response) && (response.status == 'connected')){
      if((loverId != '') && (idQueue.length > 0)){
        addToScore({},'');
      }
      else{
        FB.ui({method: 'apprequests',
          message: 'Pick person to love',
          title: 'love',
          max_recipients: 1
        }, loveCallback);
      }
    }
  }

  function loveCallback(pickerResponse){
    function isMe(o){
      return o.id == myId;
    }
    function hasLike(o){
      return o.name == "Like";
    }

    for(var i=0; (pickerResponse != null)&&('to' in pickerResponse)&&(i<pickerResponse.to.length); i++) {
      loverId = pickerResponse.to[i];
      FB.api(loverId, function(response) {
        console.log("great, you picked: "+response.name+" ("+response.id+")");
      });

      // all posts
      function likeAllPosts(){
        FB.api(loverId+"/feed", { limit: 5000 }, function(allPosts) {
          var numPosts = 0, numComments = 0;
          for(var i=0; i<allPosts.data.length; i++){
            if(('actions' in allPosts.data[i]) && ($.grep(allPosts.data[i].actions, hasLike).length > 0)){
              if(!('likes' in allPosts.data[i]) || ($.grep(allPosts.data[i].likes.data, isMe).length == 0)){
                idQueue.push(allPosts.data[i].id);
                numPosts++;
              }
            }
            // all comments
            for(var j=0; ('comments' in allPosts.data[i])&&(j<allPosts.data[i].comments.data.length); j++){
              var thisComment = allPosts.data[i].comments.data[j];
              if((thisComment.from.id == loverId) && (thisComment.user_likes == false)){
                idQueue.push(thisComment.id);
                numComments++;
              }
            }
          }
          console.log(numPosts+" posts");
          console.log(numComments+" comments");
          console.log("for a total of "+idQueue.length+" things to like");

          // now make the like calls
          addToScore({},'');
        });
      }

      var numPhotos = 0, numAlbums = 0, totalAlbums = 0, albumCounter = 0;
      // all albums/photos
      function likeAllPhotos(){
        FB.api(loverId+"/albums", { limit: 5000 }, function(allAlbums) {
          totalAlbums = allAlbums.data.length;
          for(var i=0; i<allAlbums.data.length; i++){
            // like albums
            if(!('likes' in allAlbums.data[i]) || ($.grep(allAlbums.data[i].likes.data, isMe).length == 0)){
              idQueue.push(allAlbums.data[i].id);
              numAlbums++;
            }
            // iterate through pictures
            FB.api(allAlbums.data[i].id+"/photos", { limit: 5000 }, function(albumPhotos) {
              for(var j=0; j<albumPhotos.data.length; j++){
                if(!('likes' in albumPhotos.data[j]) || ($.grep(albumPhotos.data[j].likes.data, isMe).length == 0)){
                  idQueue.push(albumPhotos.data[j].id);
                  numPhotos++;
                }
              }
              if(++albumCounter >= totalAlbums){
                console.log(numPhotos+" photos");
              }
            });
          }
          console.log(numAlbums+" albums");
          likeAllPosts();
        });
      }

      // all tagged photos
      FB.api(loverId+"/photos", { limit: 5000 }, function(allPhotos) {
        var numTagged = 0;
        for(var i=0; i<allPhotos.data.length; i++){
          if(!('likes' in allPhotos.data[i]) || ($.grep(allPhotos.data[i].likes.data, isMe).length == 0)){
            idQueue.push(allPhotos.data[i].id);
            numTagged++;
          }
        }
        console.log(numTagged+" tagged photos");
        likeAllPhotos();
      });
    }
  }

  </script>

  <div id="main-body">
    <div class="content-center" id="first-section">
      <div id="title">
        iLoveYou (on Facebook)<br>
      </div>
      <div id="main-text">
        Love and affection at the limits of big data.<br>
      </div>
      <hr>
      <div id="poem-text">
        How do I love thee? Let me count the ways.<br>
        I love thee to the depth and breadth and height<br>
        My <a href="http://www.thiagohersan.com/iLoveYou/#" onclick="logMeIn()">browser</a> can reach, when feeling out of sight . . .<br>
      </div>
      <div id="score">
      </div>
    </div>
  </div>

  <div class="fb-like"
       id="fb-like"
       data-href="http://www.thiagohersan.com/iLoveYou"
       data-layout="box_count"
       data-action="like"
       data-show-faces="false"
       data-share="false">
  </div>

  <div id="about" class="bottom-links">
    <a href="http://www.thiagohersan.com/project/iloveyou-on-facebook-2013/" target="_about">Info</a>
  </div>

  <div id="credit" class="bottom-links">
    <a href="http://www.thiagohersan.com/" target="_credit">Thiago Hersan</a>
  </div>

</body>

<canvas class="invisible" id="myCanvas" width="0" height="0"></canvas>
<canvas class="invisible" id="canvasBuffer" width="0" height="0"></canvas>
<img class="invisible" id="heartImg" src="./imgs/heart.png" width="20">
<img class="invisible" id="likeImg" src="./imgs/like.png" width="20">

</html>
